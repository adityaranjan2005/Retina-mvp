<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retinal Vessel Analysis System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #000000;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #ffffff;
        }

        .header {
            background: #000000;
            color: #ffffff;
            padding: 40px 60px;
            border-bottom: 1px solid #e0e0e0;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 0.95em;
            font-weight: 300;
            color: #cccccc;
            letter-spacing: 0.3px;
        }

        .content {
            padding: 60px;
        }

        .upload-section {
            margin-bottom: 60px;
        }

        .upload-box {
            border: 2px dashed #d0d0d0;
            padding: 80px 40px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .upload-box:hover {
            background: #f5f5f5;
            border-color: #000000;
        }

        .upload-box.dragover {
            background: #f0f0f0;
            border-color: #000000;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 1.1em;
            color: #000000;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .upload-subtext {
            color: #666666;
            font-size: 0.85em;
            font-weight: 300;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: #000000;
            color: #ffffff;
            border: none;
            padding: 14px 36px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 24px;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.3px;
        }

        .btn:hover {
            background: #333333;
        }

        .btn:disabled {
            background: #e0e0e0;
            color: #999999;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 60px 40px;
            background: #fafafa;
            margin: 40px 0;
        }

        .spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #000000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            font-size: 0.9em;
            color: #666666;
            font-weight: 400;
        }

        .results {
            display: none;
        }

        .results h2 {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 40px;
            letter-spacing: -0.3px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-bottom: 60px;
        }

        .result-card {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            padding: 0;
            overflow: hidden;
        }

        .result-card h3 {
            color: #000000;
            padding: 20px 24px;
            font-size: 0.95em;
            font-weight: 600;
            letter-spacing: 0.3px;
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-card img {
            width: 100%;
            display: block;
            background: #000000;
        }

        .metrics-section {
            background: #000000;
            color: #ffffff;
            padding: 40px;
        }

        .metrics-section h3 {
            margin-bottom: 30px;
            font-size: 1.2em;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 24px;
        }

        .metric-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 24px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-label {
            font-size: 0.75em;
            color: #cccccc;
            margin-bottom: 8px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .metric-unit {
            font-size: 0.7em;
            color: #999999;
            font-weight: 300;
            margin-top: 4px;
        }

        .preview-section {
            margin-bottom: 40px;
            padding: 40px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .preview-section h3 {
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 20px;
            letter-spacing: 0.3px;
        }

        .preview-section img {
            max-width: 600px;
            max-height: 400px;
            display: inline-block;
            border: 1px solid #e0e0e0;
        }

        .error {
            background: #000000;
            color: #ffffff;
            padding: 16px 24px;
            margin: 20px 0;
            display: none;
            font-size: 0.9em;
            border: 1px solid #000000;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding: 20px 24px;
            background: #ffffff;
            border-top: 1px solid #e0e0e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #e0e0e0;
        }

        .color-artery {
            background: #ff0000;
        }

        .color-vein {
            background: #0000ff;
        }

        .color-bg {
            background: #000000;
        }

        .methodology-section {
            margin-top: 50px;
            padding-top: 40px;
            border-top: 1px solid #e0e0e0;
        }

        .methodology-section h2 {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 25px;
            letter-spacing: -0.3px;
        }

        .method-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 35px;
        }

        .method-card {
            background: #fafafa;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .method-card h4 {
            font-size: 0.75em;
            font-weight: 600;
            letter-spacing: 0.8px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .method-card p {
            font-size: 0.8em;
            line-height: 1.6;
            color: #333333;
            font-weight: 300;
        }

        .method-card strong {
            font-weight: 500;
            color: #000000;
        }

        .acknowledgments {
            background: #000000;
            color: #ffffff;
            padding: 25px;
            margin: 35px 0;
        }

        .acknowledgments h3 {
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 18px;
            letter-spacing: -0.3px;
        }

        .ack-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .ack-item p {
            font-size: 0.8em;
            line-height: 1.6;
            margin-bottom: 8px;
            color: #cccccc;
        }

        .ack-item p strong {
            color: #ffffff;
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
        }

        .disclaimer {
            background: #fafafa;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-left: 4px solid #000000;
        }

        .disclaimer h4 {
            font-size: 0.75em;
            font-weight: 600;
            letter-spacing: 0.8px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .disclaimer p {
            font-size: 0.8em;
            line-height: 1.6;
            color: #666666;
            font-weight: 300;
        }

        @media (max-width: 1200px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .method-grid {
                grid-template-columns: 1fr;
            }
            .ack-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RETINAL VESSEL ANALYSIS SYSTEM</h1>
            <p>Clinical-Grade Fundus Image Segmentation & Quantitative Analysis</p>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="upload-box" id="uploadBox">
                    <div class="upload-icon">↑</div>
                    <div class="upload-text">Upload Fundus Image</div>
                    <div class="upload-subtext">PNG, JPG, TIFF, PPM formats supported</div>
                </div>
                <input type="file" id="fileInput" accept="image/*">
                <button class="btn" id="analyzeBtn" disabled>ANALYZE</button>
            </div>

            <!-- Preview Section -->
            <div class="preview-section" id="previewSection" style="display: none;">
                <h3>INPUT IMAGE</h3>
                <img id="previewImage" alt="Preview">
            </div>

            <!-- Loading Section -->
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>Processing image analysis...</p>
            </div>

            <!-- Error Section -->
            <div class="error" id="errorSection"></div>

            <!-- Results Section -->
            <div class="results" id="resultsSection">
                <h2>ANALYSIS RESULTS</h2>
                
                <div class="results-grid">
                    <div class="result-card">
                        <h3>VESSEL SEGMENTATION</h3>
                        <img id="vesselImage" alt="Vessel Segmentation">
                    </div>
                    <div class="result-card">
                        <h3>CENTERLINE EXTRACTION</h3>
                        <img id="centerlineImage" alt="Centerline">
                    </div>
                    <div class="result-card">
                        <h3>ARTERY/VEIN CLASSIFICATION</h3>
                        <img id="avImage" alt="A/V Classification">
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color color-artery"></div>
                                <span>Artery</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color color-vein"></div>
                                <span>Vein</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color color-bg"></div>
                                <span>Background</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="metrics-section">
                    <h3>QUANTITATIVE METRICS</h3>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-label">Centerline Length</div>
                            <div class="metric-value" id="metricLength">-</div>
                            <div class="metric-unit">pixels</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Branch Points</div>
                            <div class="metric-value" id="metricBranch">-</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Endpoints</div>
                            <div class="metric-value" id="metricEndpoints">-</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Tortuosity (Mean)</div>
                            <div class="metric-value" id="metricTortMean">-</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Tortuosity (Max)</div>
                            <div class="metric-value" id="metricTortMax">-</div>
                        </div>
                    </div>
                </div>

                <!-- Methodology Section -->
                <div class="methodology-section">
                    <h2>METHODOLOGY & TECHNICAL OVERVIEW</h2>
                    
                    <div class="method-grid">
                        <div class="method-card">
                            <h4>PRINCIPLES</h4>
                            <p>This system employs deep learning-based semantic segmentation using a multi-head U-Net architecture with ResNet34 encoder. The model performs pixel-wise classification to identify retinal blood vessels, extract centerline skeletons, and classify arteries versus veins from fundus photography.</p>
                        </div>

                        <div class="method-card">
                            <h4>PROCEDURE</h4>
                            <p><strong>1. Preprocessing:</strong> Input images are normalized using ImageNet statistics and resized to 256×256 pixels.<br>
                            <strong>2. Segmentation:</strong> Three parallel heads predict vessel masks, centerline structures, and A/V classifications.<br>
                            <strong>3. Post-processing:</strong> Morphological closing bridges small gaps, and skeletonization extracts vessel centerlines.<br>
                            <strong>4. Quantification:</strong> Graph-based analysis computes metrics including branch points, endpoints, and tortuosity indices.</p>
                        </div>

                        <div class="method-card">
                            <h4>THEORETICAL BASIS</h4>
                            <p>The architecture combines encoder-decoder networks for semantic segmentation with loss functions optimized for medical imaging: Binary Cross-Entropy with Logits (BCE) and Dice coefficient for vessel/centerline heads, Cross-Entropy for multi-class A/V classification. Centerline tortuosity is computed as the ratio of actual path length to Euclidean distance between endpoints, providing a proxy for vessel curvature and potential pathological indicators.</p>
                        </div>

                        <div class="method-card">
                            <h4>CLINICAL RELEVANCE</h4>
                            <p>Retinal vessel analysis provides non-invasive biomarkers for systemic diseases including diabetic retinopathy, hypertension, and cardiovascular conditions. Quantitative metrics such as vessel tortuosity, branching patterns, and artery-to-vein ratios correlate with disease severity and progression, enabling early detection and monitoring of microvascular complications.</p>
                        </div>
                    </div>

                    <div class="acknowledgments">
                        <h3>ACKNOWLEDGMENTS</h3>
                        <div class="ack-content">
                            <div class="ack-item">
                                <p><strong>Dataset Sources:</strong></p>
                                <p>Training data courtesy of publicly available retinal imaging datasets from Kaggle and Clemson University. These datasets include fundus photographs with expert-annotated ground truth segmentations, enabling supervised learning approaches for vessel detection and classification.</p>
                            </div>
                            <div class="ack-item">
                                <p><strong>Developer:</strong></p>
                                <p><strong>Aditya Ranjan</strong><br>Entrepreneur and Social Worker<br>Dedicating his free time to medical welfare initiatives and developing accessible healthcare technology for underserved communities, advancing health equity through AI-powered diagnostic solutions.</p>
                            </div>
                        </div>
                    </div>

                    <div class="disclaimer">
                        <h4>MEDICAL DISCLAIMER</h4>
                        <p>This tool is designed for research and educational purposes only. It is not intended for clinical diagnosis or treatment decisions. All medical interpretations should be performed by qualified healthcare professionals. The automated analysis provided by this system should be used as a supplementary tool and not as a replacement for expert clinical judgment.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const previewSection = document.getElementById('previewSection');
        const previewImage = document.getElementById('previewImage');
        const loadingSection = document.getElementById('loadingSection');
        const errorSection = document.getElementById('errorSection');
        const resultsSection = document.getElementById('resultsSection');

        let selectedFile = null;

        // Click to upload
        uploadBox.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('dragover');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            selectedFile = file;
            analyzeBtn.disabled = false;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewSection.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        analyzeBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // Hide previous results and errors
            resultsSection.style.display = 'none';
            errorSection.style.display = 'none';
            loadingSection.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('use_cloudinary', 'true');

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Display results
                    document.getElementById('vesselImage').src = data.vessel_image;
                    document.getElementById('centerlineImage').src = data.centerline_image;
                    document.getElementById('avImage').src = data.av_image;

                    // Display metrics
                    document.getElementById('metricLength').textContent = 
                        Math.round(data.metrics.centerline_length_px);
                    document.getElementById('metricBranch').textContent = 
                        data.metrics.branch_points;
                    document.getElementById('metricEndpoints').textContent = 
                        data.metrics.endpoints;
                    document.getElementById('metricTortMean').textContent = 
                        data.metrics.tortuosity_proxy_mean.toFixed(3);
                    document.getElementById('metricTortMax').textContent = 
                        data.metrics.tortuosity_proxy_max.toFixed(3);

                    resultsSection.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
            } catch (error) {
                errorSection.textContent = `Error: ${error.message}`;
                errorSection.style.display = 'block';
            } finally {
                loadingSection.style.display = 'none';
            }
        });
    </script>
</body>
</html>
